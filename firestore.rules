rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Deny all reads/writes by default
    match /{document=**} {
      allow read, write: if false;
    }

    // USERS collection
    // Users can only be created if the data contains their own UID.
    // Users can read, update, and delete their own profile.
    // Logged-in users can read public profiles of others.
    match /users/{userId} {
      allow create: if request.auth.uid == request.resource.data.uid;
      allow read, update, delete: if request.auth.uid == userId;
    }
    
    // WORKOUTS collection
    // Users can list their own workouts.
    // Users can create a workout if the workout data contains their UID.
    // Users can read, update, and delete their own workouts.
    // Logged-in users can list all workouts (for the feed).
    match /workouts/{workoutId} {
        allow list: if request.auth.uid != null;
        allow read, update, delete: if request.auth.uid == resource.data.userId;
        allow create: if request.auth.uid == request.resource.data.userId;
    }

    // NUTRITION sub-collection
    // Users can create, read, update, delete their own nutrition data.
    match /users/{userId}/nutrition/{date} {
      allow read, write, create, delete: if request.auth.uid == userId;
    }

    // MEALS sub-collection
    // Users can create, read, update, delete their own meal data.
    match /users/{userId}/meals/{mealId} {
      allow read, write, create, delete: if request.auth.uid == userId;
    }

    // WATER sub-collection
    // Users can create, read, update, delete their own water intake data.
    match /users/{userId}/water/{date} {
      allow read, write, create, delete: if request.auth.uid == userId;
    }
  }
}
