rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Users Collection
    match /users/{userId} {
      // Users can read their own profile.
      allow read: if request.auth.uid == userId;
      
      // Users can create their own profile document, but only once.
      // The user must be authenticated.
      // The `uid` in the document must match their auth uid.
      allow create: if request.auth != null && request.resource.data.uid == request.auth.uid;
      
      // Users can update their own profile.
      allow update: if request.auth.uid == userId;

      // Users cannot delete their profiles through the client.
      allow delete: if false;
    }
    
    // Workouts Collection
    match /workouts/{workoutId} {
      // Allow users to read, create, update, and delete their own workouts.
      // For reads, also allow any authenticated user to read any workout (for public feeds).
      allow read: if request.auth != null;
      allow write: if request.auth.uid == request.resource.data.userId;
    }

    // Nutrition & Water subcollections
    match /users/{userId}/{collection}/{docId} {
        // Users can manage their own nutrition and water data.
        allow read, write: if request.auth.uid == userId;
    }
     // Meals subcollection
    match /users/{userId}/meals/{mealId} {
      allow read, write: if request.auth.uid == userId;
    }
  }
}
